# ğŸ›¡ï¸ Multi-Agent AI Phishing Detection System with CrewAI and Human-in-the-Loop

![Phishing Analyzer Cover](images/title.png)

Phishing attacks remain one of the most persistent and damaging cybersecurity threats faced by organizations today. Security teams must quickly analyze suspicious emails while ensuring legitimate communication is not mistakenly blocked. This requires systems that are not only accurate but also transparent and explainable.

This project presents a multi-agent AI phishing detection system that combines deterministic security analysis with explainable AI. The architecture is designed to simulate how real-world Security Operations Centers (SOC) investigate suspicious emails using layered detection, structured risk scoring, and human validation.

Instead of relying solely on large language models, the system prioritizes deterministic detection for reliability and uses AI only for explanation. A human-in-the-loop stage ensures that final decisions remain interpretable and safe, making the system suitable for real-world cybersecurity workflows.


---

## ğŸŒ Real-World Cybersecurity Impact

This system demonstrates how multi-agent AI can improve phishing detection in real-world security environments. It enables security teams to automatically analyze suspicious emails, reduce manual investigation time, and generate explainable phishing risk scores that can be reviewed before taking action.

The architecture reflects how modern Security Operations Centers combine deterministic detection, AI reasoning, and human oversight to prevent phishing attacks safely while maintaining operational efficiency.

---

## âœ¨ Key Features

âœ… Deterministic phishing detection (no AI hallucinations)

âœ… Email header analysis (SPF, DKIM, DMARC)

âœ… Content inspection for phishing language & URLs

âœ… DNS & WHOIS domain intelligence

âœ… Policy-driven risk scoring

âœ… Prefect-based orchestration

âœ… Optional CrewAI explanation layer (non-decision-making)

âœ… Fully unit-tested using pytest

âœ… Python 3.11 compatible (Windows & Linux)

---

## ğŸ§  Architecture Overview

The following diagram illustrates how multiple specialized agents collaborate within a structured orchestration pipeline.

![Architecture Diagram](images/architecture.png)

> **Deterministic detection first, LLM explanation second**

## ğŸ“ Project Structure

```
phishing_analyzer_project/
â”‚
â”œâ”€â”€ phishing_analyzer/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚
â”‚   â”œâ”€â”€ agents/                     # Multi-agent system modules
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ detection_agent.py      # Detection Agent â€“ performs phishing analysis
â”‚   â”‚   â”œâ”€â”€ risk_agent.py           # Risk Scoring Agent â€“ calculates severity & action
â”‚   â”‚   â”œâ”€â”€ explanation_agent.py    # Explanation Agent (CrewAI) â€“ generates AI explanation
â”‚   â”‚   â””â”€â”€ human_agent.py          # Human-in-the-loop Agent â€“ analyst validation step
â”‚   â”‚
â”‚   â”œâ”€â”€ samples/                    # Sample .eml phishing emails for testing
â”‚   â”œâ”€â”€ detector.py                 # Core detection & scoring engine logic
â”‚   â”œâ”€â”€ guardrails.py               # Safety policies, validation & redaction
â”‚   â”œâ”€â”€ prefect_flow.py             # Prefect orchestration for multi-agent pipeline
â”‚   â””â”€â”€ crewai_explainer.py         # CrewAI-based optional explanation engine
â”‚
â”œâ”€â”€ tests/                          # Unit tests (pytest)
â”‚   â”œâ”€â”€ test_ingestion.py
â”‚   â”œâ”€â”€ test_header_analysis.py
â”‚   â”œâ”€â”€ test_content_analysis.py
â”‚   â”œâ”€â”€ test_dns_auth.py
â”‚   â”œâ”€â”€ test_domain_analysis.py
â”‚   â””â”€â”€ test_risk_scoring.py
â”‚
â”œâ”€â”€ images/
â”‚   â”œâ”€â”€ title.png
â”‚   â””â”€â”€ architecture.png            # Architecture & cover images
â”‚
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ pyproject.toml
â””â”€â”€ README.md

```
---
## ğŸ¤– Multi-Agent Architecture

This project implements a structured multi-agent phishing detection system where specialized agents collaborate to analyze suspicious emails and generate a final security assessment.

### 1ï¸âƒ£ Detection Agent
Performs deep phishing detection by analyzing:
- Email headers and sender anomalies  
- Email content and phishing indicators  
- Domain intelligence and age  
- SPF, DKIM, and DMARC authentication  

This agent produces structured technical findings from the email.

---

### 2ï¸âƒ£ Risk Scoring Agent
Calculates the overall phishing risk score based on signals generated by the Detection Agent.

Responsibilities:
- Assigns phishing severity level (Low, Medium, High)  
- Determines recommended action (Allow, Flag, Quarantine, Block)  
- Produces final risk assessment  

---

### 3ï¸âƒ£ Explanation Agent (CrewAI)
Generates a human-readable explanation of the phishing analysis for security analysts and non-technical stakeholders.

- Uses CrewAI to simulate a SOC security analyst  
- Explains why an email was classified with a given risk  
- Improves transparency and interpretability  

This agent is optional at runtime but remains an integral part of the multi-agent architecture.

---

### 4ï¸âƒ£ Human Review Agent (Human-in-the-Loop)
Implements a human validation step before final action is taken.

- Allows a security analyst to approve, block, or escalate  
- Prevents fully autonomous decision-making  
- Ensures safe deployment in real-world environments  

---

### ğŸ”„ Orchestration
All agents are orchestrated using a Prefect workflow that coordinates execution, ensures reliability, and manages the end-to-end phishing analysis pipeline.

---

## âš™ï¸ How It Works

This system analyzes suspicious emails using a coordinated multi-agent pipeline that combines deterministic phishing detection, risk scoring, AI explanation, and human validation.

Each agent performs a specialized role to ensure reliable and explainable phishing detection.

---

## ğŸ”„ Agent Workflow

The system follows a structured multi-agent workflow:

1. **Email Ingestion**  
   Loads and parses email data from `.eml` files.

2. **Detection Agent**  
   Analyzes headers, content, domains, and authentication signals to identify phishing indicators.

3. **Risk Scoring Agent**  
   Calculates overall phishing risk score and determines severity and recommended action.

4. **Human Review Agent (Human-in-the-Loop)**  
   Allows a security analyst to approve, block, or escalate the decision before final output.

5. **Explanation Agent (CrewAI)**  
   Generates a human-readable explanation of the analysis for analysts and stakeholders.

This structured workflow ensures reliable phishing detection while maintaining transparency and human oversight.

---

## ğŸ§  Why a Multi-Agent Approach?

Traditional phishing detection systems often rely on a single model or rule-based engine, which can limit transparency and reliability. This system adopts a multi-agent architecture where each agent performs a specialized task such as header inspection, content analysis, domain intelligence, and risk scoring.

By separating responsibilities across agents, the system becomes easier to maintain, test, and extend. Each agent contributes structured findings that are combined into a final risk assessment, making the decision process transparent and explainable.

This modular approach mirrors how real-world security teams analyze suspicious emails using layered validation rather than relying on a single automated decision.

---

## âš™ï¸ Deterministic Detection with AI Explanation

The system prioritizes deterministic phishing detection techniques such as header validation, domain intelligence, authentication checks, and structured risk scoring. These methods provide reliable and reproducible results.

AI is used selectively for generating human-readable explanations of the findings rather than making final decisions. This hybrid approach ensures both accuracy and transparency, allowing analysts to understand why an email is flagged without relying entirely on probabilistic model outputs.


---

## ğŸ¢ Practical Use in Security Operations

This architecture can support enterprise email security teams by automating the initial analysis of suspicious emails while maintaining human oversight. Security analysts can use the structured output to make faster and more consistent decisions.

The system can also serve as a foundation for building SOC automation tools, training datasets, or advanced threat analysis pipelines where explainability and reliability are critical.

---
## âš™ï¸ Installation
### Requirements

Python 3.11 (recommended)

### Install Dependencies
```bash
python -m pip install -r requirements.txt
python -m pip install -e .
```
CrewAI is optional. Uncomment it in requirements.txt only if required.
---
## â–¶ï¸ Running the Analyzer
```bash
C:\Python311\python.exe -m phishing_analyzer.prefect_flow --eml phishing_analyzer/samples/phish_high_confidence.eml
```
---
## ğŸ§ª Testing

Run all unit tests:

```bash
python -m pytest -v
```

Tests cover:
 - Email ingestion
 - Header anomaly detection
 - Content analysis logic
 - DNS / WHOIS handling
 - Policy-based risk scoring
---

## ğŸ“¤ Sample Output (Highâ€‘Confidence Phishing)

### Input

samples/phish_high_confidence.eml

```
================ FINAL REPORT ================

1ï¸âƒ£ EXECUTIVE SUMMARY
This email shows strong indicators commonly associated with phishing attacks.

2ï¸âƒ£ FINAL VERDICT
Decision: Block

3ï¸âƒ£ RISK SCORE
Score: 36
Severity: High

4ï¸âƒ£ KEY FINDINGS
- Header issue: SPF failed
- Header issue: DMARC failed
- Content indicator: Urgent or credential-harvesting language detected
- Domain age: Unable to determine
- Authentication issue: SPF missing
- Authentication issue: DMARC missing
- Authentication issue: DKIM missing

5ï¸âƒ£ EVIDENCE
From Email: alert@goog1e-security.com
From Domain: goog1e-security.com
SPF Result: fail
DKIM Result: missing
DMARC Result: spf=fail dkim=none dmarc=fail

6ï¸âƒ£ SUGGESTED ACTION
Do NOT interact with this email. Block sender and report to security.

================ AI EXPLANATION ================

{'status': 'skipped', 'reason': 'CrewAI not installed'}

```

---

## ğŸ§  Design Principles

- Deterministic security logic first
- LLMs used only for explainability
- Fail-safe risk elevation
- SOC-aligned architecture
- Strong guardrails & sanitization
- High test coverage

---

## âš ï¸ Limitations and Future Improvements

While the system demonstrates a robust multi-agent architecture, it currently focuses on deterministic phishing detection using structured signals. Future improvements could include integration with threat intelligence feeds, advanced URL sandboxing, and continuous learning from analyst feedback.

The modular design allows these enhancements to be incorporated without major architectural changes.

---

## ğŸ“œ License

MIT License

---
This project demonstrates how multi-agent AI systems can be safely applied in cybersecurity environments where reliability, explainability, and human oversight are critical.
